
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="index, follow" />

  <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Source+Sans+Pro:300,400,400i,700" rel="stylesheet">

    <link rel="stylesheet/less" type="text/css" href="https://blog.solvik.fr/theme/stylesheet/style.less">
    <script src="//cdnjs.cloudflare.com/ajax/libs/less.js/2.5.1/less.min.js" type="text/javascript"></script>

  <link rel="stylesheet" type="text/css" href="https://blog.solvik.fr/theme/pygments/monokai.min.css">
  <link rel="stylesheet" type="text/css" href="https://blog.solvik.fr/theme/font-awesome/css/font-awesome.min.css">


    <link href="https://blog.solvik.fr/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="A Pelican Blog Atom">




    <!-- Chrome, Firefox OS and Opera -->
    <meta name="theme-color" content="#3338db">
    <!-- Windows Phone -->
    <meta name="msapplication-navbutton-color" content="#3338db">
    <!-- iOS Safari -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Microsoft EDGE -->
    <meta name="msapplication-TileColor" content="#3338db">

    <meta name="author" content="Solvik Blum" />
    <meta name="description" content="" />
<meta property="og:site_name" content="A Pelican Blog"/>
<meta property="og:type" content="blog"/>
<meta property="og:title" content="A Pelican Blog"/>
<meta property="og:description" content=""/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://blog.solvik.fr"/>

  <title>A Pelican Blog &ndash;     Tag deployment
</title>

</head>
<body>
  <aside>
    <div>
      <a href="https://blog.solvik.fr">
        <img src="https://blog.solvik.fr/theme/img/profile.png" alt="/home/solvik" title="/home/solvik">
      </a>
      <h1><a href="https://blog.solvik.fr">/home/solvik</a></h1>

<p>my place of sharing</p>
      <nav>
        <ul class="list">
          <li><a href="https://blog.solvik.fr/pages/about-me.html#about-me">About @me</a></li>

        </ul>
      </nav>

      <ul class="social">
        <li><a class="sc-linkedin" href="https://www.linkedin.com/in/solvikblum" target="_blank"><i class="fa fa-linkedin"></i></a></li>
        <li><a class="sc-twitter" href="https://twitter.com/solvik" target="_blank"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-github" href="https://github.com/Solvik" target="_blank"><i class="fa fa-github"></i></a></li>
      </ul>
    </div>


  </aside>
  <main>

    <nav>
      <a href="https://blog.solvik.fr">    Home
</a>

      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>

      <a href="https://blog.solvik.fr/feeds/all.atom.xml">    Atom
</a>

    </nav>



<article>
  <header>
    <h2><a href="https://blog.solvik.fr/salt-stack.html#salt-stack">Salt</a></h2>
    <p>
          Posted on avril 24, 2014 in <a href="https://blog.solvik.fr/category/system.html">System</a>



    </p>
  </header>
  <div>
      <p>Since a few months, I've been inclined to test and use <a href="www.saltstack.com">Salt Stack</a>.
I manage a lot a heterogeneous plateforms, but each one are composed of similar machines who does the same stuff.</p>
<p>For example, once three months, I'm being asked to install a new packages, configure a new printer on desktop machines of our datacenter's collaborators.
What a great use case :)</p>
<h2>Introduction</h2>
<p>Salt is like Puppet and Chef, which are also deployment and automation tools. I find it more lightweight and</p>
<h2>Installation</h2>
<p>It seems that Salt Stack is not yet in the official Ubuntu repositories</p>
<p>Things to do on your master host:</p>
<div class="highlight"><pre><span></span>apt-get install python-software-properties
add-apt-repository ppa:saltstack/salt

apt-get update
apt-get install salt-master
</pre></div>


<p>Things to do on your client host:</p>
<div class="highlight"><pre><span></span>apt-get install python-software-properties
add-apt-repository ppa:saltstack/salt

apt-get update
apt-get install salt-minion
</pre></div>


<p>By default a Salt Minion will try to connect to the DNS name "salt"; if the Minion is able to resolve that name correctly, no configuration is needed.
If the DNS name "salt" does not resolve, you need to edit <strong>/etc/salt/minion</strong></p>
<div class="highlight"><pre><span></span>master: <span class="m">192</span>.168.0.2
</pre></div>


<p>Restart everything</p>
<p>Master</p>
<div class="highlight"><pre><span></span>/etc/init.d/salt-master restart
</pre></div>


<p>Minion</p>
<div class="highlight"><pre><span></span>/etc/init.d/salt-minion restart
</pre></div>


<h2>Communication</h2>
<p>Communications bettwen the Master and your Minions is done via <a href="http://fr.wikipedia.org/wiki/Advanced_Encryption_Standard">AES encryption</a>. But to communicate, your Minion's key must be accepted by the Master</p>
<p>List all keys:</p>
<div class="highlight"><pre><span></span>$ salt-key -L
Accepted Keys:
Unaccepted Keys:
NOC1-VTY2
NOC2-VTY2
NOC3-VTY2
NOC4-VTY2
Rejected Keys:
</pre></div>


<p>Accept all keys</p>
<div class="highlight"><pre><span></span>$ salt-key -A
</pre></div>


<p>Accept one key</p>
<div class="highlight"><pre><span></span>$ salt-key -a NOC1-VTY2
</pre></div>


<p>If you list your keys again you should get an output like this:</p>
<div class="highlight"><pre><span></span>$ salt-key -L
Accepted Keys:
NOC1-VTY2
NOC2-VTY2
NOC3-VTY2
NOC4-VTY2
Unaccepted Keys:
Rejected Keys:
</pre></div>


<p>You can now test the communication between your Master and one of all of your Minions</p>
<div class="highlight"><pre><span></span>$ salt <span class="s1">&#39;NOC1-VTY2&#39;</span> test.ping
NOC1-VTY2:
    True
$ salt <span class="s1">&#39;*&#39;</span> test.ping
NOC3-VTY2:
    True
NOC4-VTY2:
    True
NOC1-VTY2:
    True
NOC2-VTY2:
    True
</pre></div>


<h2>Deployment</h2>
<p>Now, I want to be able to add another computer to our NOC team without having to push manually all the configurations (NIS/NFS/packages etc)</p>
<p>There is two major things, the directive <strong>file_roots</strong> and the file <strong>top.sls</strong>
According to the <a href="http://docs.saltstack.com/en/latest/topics/tutorials/starting_states.html">documentation</a>, SLS (or SaLt State file) is a representation of the state in which a system should be in.</p>
<p>file_roots</p>
<h4></h4>
<p>In your <strong>/etc/salt/master</strong> file, you need to uncomment the file_roots directive. It defines the location of the Salt file server and the SLS definitions.
Mine look like this</p>
<div class="highlight"><pre><span></span><span class="n">file_roots</span><span class="o">:</span>
  <span class="n">base</span><span class="o">:</span>
    <span class="o">-</span> <span class="sr">/srv/salt/</span>
</pre></div>


<p>After this modification, restart your server</p>
<p>top.sls</p>
<h4></h4>
<p>Doing specific stuff to specific machines in the main purpose of Salt.
This is defined within the <strong>top.sls</strong> file.</p>
<p>This can be done by:</p>
<table>
<thead>
<tr>
<th>Ways</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>Globbing</td>
<td>"webserver<em>prod</em>"</td>
</tr>
<tr>
<td>Regular Expressions</td>
<td>"^(memcache&#124;web).(qa&#124;prod).loc$"</td>
</tr>
<tr>
<td>Lists</td>
<td>"dev1,dev2,dev3"</td>
</tr>
<tr>
<td>Grains</td>
<td>"os:CentOS"</td>
</tr>
<tr>
<td>Pillar</td>
<td></td>
</tr>
<tr>
<td>Node Groups</td>
<td></td>
</tr>
<tr>
<td>Compound Matching</td>
<td></td>
</tr>
</tbody>
</table>
<p>This is my top.sls file:</p>
<div class="highlight"><pre><span></span>base:
   &#39;*&#39;:
     - nagios.client
   &#39;os:Ubuntu&#39;:
     - repos.online
   &#39;^NOC(\d)+-VTY2$&#39;:
     - match: pcre
     - yp.install
     - yp.nsswitch
     - nfs.mount_noc
</pre></div>


<p>base:</p>
<h4></h4>
<div class="highlight"><pre><span></span>base:
   &#39;*&#39;:
     - nagios.client
</pre></div>


<p>This block declare the global environment the minion must apply.
In this case, every machine will be assigned the nagios.client directive
It's going to execute <em>/srv/salt/nagios/client.sls</em></p>
<p>os:Ubuntu</p>
<h4></h4>
<p>This section matches machine using the Salt "grain" system, basically from system attributes.
It will execute <em>/srv/salt/repos/online.sls</em></p>
<p>'^NOC(\d)+-VTY2$'</p>
<h4></h4>
<p>This section matches using Perl regular expression feature
If the hostname of the machine matches this regex, it will be assigned the few directives
It will execute, <em>/srv/salt/nagios/yp/install.sls</em>, <em>/srv/salt/nagios/yp/nsswitch.sls</em>, <em>/srv/salt/nagios/nfs/mount_noc.sls</em></p>
<h2>Links</h2>
<ul>
<li><a href="http://docs.saltstack.com/en/latest/ref/configuration/index.html">http://docs.saltstack.com/en/latest/ref/configuration/index.html</a></li>
<li><a href="http://intothesaltmine.org/blog/html/2013/04/18/configuration_management_with_salt_stack_part_1.html">http://intothesaltmine.org/blog/html/2013/04/18/configuration_management_with_salt_stack_part_1.html</a></li>
</ul>
      <br>
      <a class="btn" href="https://blog.solvik.fr/salt-stack.html#salt-stack">    Continue reading
</a>
  </div>
</article>

  <div class="pagination">
  </div>




    <footer>
<p>
  &copy;  2018 - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>    Powered by <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a>
</p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
           src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " A Pelican Blog ",
  "url" : "https://blog.solvik.fr",
  "image": "",
  "description": ""
}
</script>

</body>
</html>